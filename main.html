<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kopi-Kita - Main</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
  <style>
    :root{
      --gold:#f0bd76;
      --bg-dark:rgba(10,10,10,0.9);
      --card:rgba(255,255,255,0.06);
    }
    body{
      margin:0;
      font-family:Inter, Arial, sans-serif;
      background: url("{{ url_for('static', filename='img/bg-menu.jpg') }}") center/cover fixed;
      color:#eee;
    }
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:0}
    header{position:relative;z-index:5;padding:18px 30px;background:transparent}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;border-radius:8px}
    .nav-right{display:flex;align-items:center;gap:12px}
    .cart-btn{position:relative}
    .cart-count{position:absolute;right:-8px;top:-8px;background:var(--gold);color:#111;border-radius:50%;padding:4px 7px;font-size:12px;font-weight:700}
    /* sidebar */
    .sidebar{position:fixed;right:-320px;top:0;width:320px;height:100%;background:var(--bg-dark);padding:20px;z-index:9999;transition:right .28s;overflow:auto}
    .sidebar.open{right:0}
    .hamb{font-size:22px;cursor:pointer;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;background:transparent;color:#fff}
    /* swiper style */
    .section-title{font-size:22px;color:var(--gold);margin-bottom:12px}
    .swiper{padding:30px 0}
    .swiper-slide{display:flex;justify-content:center;align-items:center}
    .card{
      width:320px;background:var(--card);border-radius:12px;padding:14px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.6);
      transition:transform .25s;
    }
    .card img{width:100%;height:420px;object-fit:cover;border-radius:10px}
    .card h5{margin-top:10px;margin-bottom:6px;color:#fff}
    .card p.desc{font-size:13px;color:#ddd;height:42px;overflow:hidden}
    .add-small{background:transparent;border:1px solid rgba(209, 196, 196, 0.08);color:#fff;padding:6px 10px;border-radius:10px;margin-top:8px}
    /* footer */
    footer{padding:28px;background:linear-gradient(180deg,rgba(255, 255, 255, 0.7),rgba(246, 246, 246, 0.9));color:#000000;margin-top:40px}
    .reserve-btn{background:var(--gold);color:#111;border:none;padding:10px 16px;border-radius:8px}
    /* projectile */
    .proj{position:fixed;width:36px;height:36px;border-radius:50%;background:var(--gold);z-index:20000;pointer-events:none;display:flex;align-items:center;justify-content:center;color:#111;font-weight:800}
    /* responsive */
    @media(max-width:768px){ .card img{height:280px} }
  </style>
</head>
<body>
  <div class="overlay"></div>

  <header class="container d-flex justify-content-between align-items-center">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo_kopikita.png') }}" alt="logo">
      <div>
        <div style="font-weight:700;font-size:18px">Kopi-Kita</div>
        <div style="font-size:12px;color:#ccc">High quality coffee & local delights</div>
      </div>
    </div>

    <div class="nav-right">
      <button class="hamb" id="hambBtn">â˜°</button>
      <a class="btn btn-outline-light" href="https://www.google.com/maps/search/?api=1&query=Jl.+Boulevard+Kelapa+Gading+Timur" target="_blank">Visit Us</a>
      <a class="btn btn-light" href="{{ url_for('checkout') }}" id="cartIcon">Cart <span class="cart-count" id="cartCount">{{ cart_count }}</span></a>
    </div>
  </header>

  <!-- sidebar -->
  <div class="sidebar" id="sidebar">
    <h4>Bantuan</h4>
    <p>Klik tombol order untuk menambahkan. Untuk reservasi tekan tombol di bawah.</p>
    <hr style="border-color:rgba(255,255,255,0.06)">
    <h5>Kontak</h5>
    <p>Admin WA: <a href="https://wa.me/6281399784582" target="_blank">0813-9997-84582</a></p>
    <h5>Alamat</h5>
    <p>Jl. Boulevard Kelapa Gading Timur, Jakarta Utara</p>
    <button class="reserve-btn" id="openReserve">Buat Reservasi</button>
  </div>

  <main class="container">
    <!-- Best seller as full hero slider -->
    <section style="margin-top:26px">
      <div class="section-title">Best Seller</div>
      <div class="swiper mySwiper1">
        <div class="swiper-wrapper">
          {% for item in menu["best_seller"] %}
          <div class="swiper-slide">
            <div class="card">
              <img src="{{ url_for('static', filename='img/' ~ item['img']) }}" alt="{{ item['name'] }}">
              <h5>{{ item['name'] }}</h5>
              <p class="desc">{{ item['desc'] }}</p>
              <form method="post" action="{{ url_for('add_to_cart') }}" class="add-form-inline">
                <input type="hidden" name="item_id" value="{{ item['id'] }}">
                <button type="submit" class="add-small">+ Tambah</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </section>

    <!-- other sections sliders -->
    {% for section, items in menu.items() if section != 'best_seller' %}
    <section style="margin-top:36px">
      <div class="section-title">{{ section.replace('_',' ').title() }}</div>
      <div class="swiper mySwiper">
        <div class="swiper-wrapper">
          {% for item in items %}
          <div class="swiper-slide">
            <div class="card">
              <img src="{{ url_for('static', filename='img/' ~ item['img']) }}" alt="{{ item['name'] }}">

              <h5>{{ item['name'] }}</h5>
              <p class="desc">{{ item['desc'] }}</p>
              <form method="post" action="{{ url_for('add_to_cart') }}" class="add-form-inline">
                <input type="hidden" name="item_id" value="{{ item['id'] }}">
                <button type="submit" class="add-small">+ Tambah</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </section>
    {% endfor %}

  </main>

  <!-- reservation modal -->
  <div id="reserveModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:20000;align-items:center;justify-content:center">
    <div style="background:#111;padding:20px;border-radius:12px;max-width:520px;color:#fff;margin:auto">
      <h4>Reservasi Kopi-Kita</h4>
      <form id="reserveForm">
        <div class="mb-2"><label>Nama</label><input class="form-control" name="res_name" required></div>
        <div class="mb-2"><label>Phone (contoh 6281..)</label><input class="form-control" name="res_phone" required></div>
        <div class="mb-2"><label>Tanggal & Waktu</label><input class="form-control" type="datetime-local" name="res_date" required></div>
        <div class="mb-2"><label>Jumlah Orang</label><input class="form-control" type="number" name="res_pax" value="2" min="1" required></div>
        <div class="mb-2"><label>Minimal Spend</label><input class="form-control" name="res_min_spend" value="350000" readonly></div>
        <div class="mb-2"><label>Catatan</label><textarea class="form-control" name="res_notes"></textarea></div>
        <div class="d-flex justify-content-end" style="gap:8px">
          <button type="button" class="btn btn-light" id="closeReserve">Batal</button>
          <button type="submit" class="reserve-btn">Kirim Reservasi</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <img src="{{ url_for('static', filename='img/logo_prasmul.png') }}" style="height:48px;margin-right:6px" alt="prasmul">
        <img src="{{ url_for('static', filename='img/logo_kopikita.png') }}" style="height:48px;border-radius:8px" alt="kopikita">
      </div>
      <div style="text-align:right">
        <div>Jl. Boulevard Kelapa Gading Timur, Jakarta Utara</div>
        <div><a href="https://wa.me/6281399784582" target="_blank" style="color:var(--gold)">Chat Admin</a></div>
      </div>
    </div>
  </footer>

  <div id="projRoot"></div>

  <script>
    // init Swipers
    const cover = new Swiper(".mySwiper1", {
      effect: "coverflow",
      centeredSlides: true,
      slidesPerView: "auto",
      coverflowEffect: { rotate:0, stretch:0, depth:200, modifier:1, slideShadows:false },
      pagination:{ el: ".swiper-pagination", clickable: true },
      navigation:{ nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" }
    });
    const sws = document.querySelectorAll(".mySwiper:not(.mySwiper1)");
    sws.forEach(s=>{
      new Swiper(s, {
        slidesPerView: 3, spaceBetween: 20, centeredSlides: true,
        breakpoints:{ 0:{slidesPerView:1}, 640:{slidesPerView:2}, 1000:{slidesPerView:3} },
        navigation:{ nextEl: s.querySelector(".swiper-button-next"), prevEl: s.querySelector(".swiper-button-prev") },
        pagination:{ el: s.querySelector(".swiper-pagination"), clickable:true }
      });
    });

    // sidebar toggle
    const sidebar = document.getElementById("sidebar");
    document.getElementById("hambBtn").addEventListener("click", ()=> sidebar.classList.toggle("open"));

    // reservation modal
    const reserveModal = document.getElementById("reserveModal");
    document.getElementById("openReserve").addEventListener("click", ()=> reserveModal.style.display = "flex");
    document.getElementById("closeReserve").addEventListener("click", ()=> reserveModal.style.display = "none");
    document.getElementById("reserveForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const data = new FormData(e.target);
      const res = await fetch("/reserve", { method:"POST", body:data });
      if(res.ok){ alert("Reservasi terkirim. Kami akan hubungi via WA."); reserveModal.style.display = "none"; }
      else { const json = await res.json().catch(()=>({msg:"Error"})); alert("Gagal: "+ (json.msg||"")); }
    });

    // projectile animation to cart
    function animateToCart(imgEl){
      const rect = imgEl.getBoundingClientRect();
      const cart = document.getElementById("cartIcon");
      const trect = cart.getBoundingClientRect();
      const proj = document.createElement("div");
      proj.className = "proj";
      proj.style.left = rect.left + "px";
      proj.style.top = rect.top + "px";
      proj.innerText = "+";
      document.body.appendChild(proj);
      gsap.to(proj, { x: trect.left - rect.left, y: trect.top - rect.top, scale:0.3, duration:0.8, onComplete: ()=>{ proj.remove(); updateCartCount(); }})
    }

    // intercept add-to-cart forms to show projectile
    document.querySelectorAll(".add-form-inline").forEach(f=>{
      f.addEventListener("submit", function(e){
        e.preventDefault();
        // take image inside same card
        const card = f.closest(".card");
        const img = card.querySelector("img");
        animateToCart(img);
        // submit form after a short delay to ensure session updated
        setTimeout(()=> f.submit(), 850);
      })
    });

    // update cart count by reload or api
    async function updateCartCount(){
      try{
        const r = await fetch("/cart_count");
        const j = await r.json();
        document.getElementById("cartCount").innerText = j.count;
      }catch(e){}
    }
    // try update on load
    updateCartCount();

  </script>
</body>
</html>
